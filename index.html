<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comptabilit√© Artiste-Auteur BNC</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover { background: #e9ecef; }
        .tab-btn[aria-selected="true"] {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-col { flex: 1; min-width: 200px; }
        
        .card {
            background: rgba(102, 126, 234, 0.05);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success { background: linear-gradient(135deg, #28a745, #20c997); }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c0392b); }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #ff9800); color: #000; }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #138496); }
        .btn-sm { padding: 8px 16px; font-size: 0.9em; }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-item h4 { font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; }
        .summary-item div { font-size: 1.4em; font-weight: 700; }
        
        .entries-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            margin-top: 15px;
        }
        
        .entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .entry:hover { background: rgba(102, 126, 234, 0.03); }
        .entry-info { flex: 1; }
        .entry-date { font-weight: 700; color: #667eea; margin-bottom: 5px; }
        .entry-description { color: #666; font-size: 0.9em; }
        .entry-actions { display: flex; gap: 8px; align-items: center; }
        
        .amount-positive { color: #27ae60; font-weight: 700; font-size: 1.1em; }
        .amount-negative { color: #e74c3c; font-weight: 700; font-size: 1.1em; }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            color: #1b6ea8;
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-group input[type="checkbox"] { width: auto; cursor: pointer; }
        .checkbox-group label { margin: 0; font-weight: 400; cursor: pointer; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover { background: #f8f9fa; }
        
        .tva-section {
            background: rgba(0, 102, 204, 0.05);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #0066cc;
            margin: 20px 0;
        }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .tabs { flex-direction: column; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíº Comptabilit√© Artiste-Auteur</h1>
            <p>Gestion BNC avec TVA - D√©claration 2042-C-PRO</p>
        </div>
        
        <div class="tabs" role="tablist">
            <button class="tab-btn" role="tab" aria-controls="saisie" aria-selected="true">üìä Saisie</button>
            <button class="tab-btn" role="tab" aria-controls="historique" aria-selected="false">üìà Historique</button>
            <button class="tab-btn" role="tab" aria-controls="synthese" aria-selected="false">üìã Synth√®se</button>
            <button class="tab-btn" role="tab" aria-controls="declaration" aria-selected="false">üìÑ D√©claration</button>
            <button class="tab-btn" role="tab" aria-controls="export" aria-selected="false">üíæ Export</button>
            <button class="tab-btn" role="tab" aria-controls="parametres" aria-selected="false">‚öôÔ∏è Param√®tres</button>
            <button class="tab-btn" role="tab" aria-controls="aide" aria-selected="false">‚ùì Aide</button>
        </div>
        
        <!-- Saisie -->
        <section id="saisie" class="tab-content active" role="tabpanel">
            <h2>Saisie des recettes et d√©penses</h2>
            
            <div class="card">
                <div class="form-row">
                    <div class="form-col">
                        <label for="entryDate">Date *</label>
                        <input type="date" id="entryDate" required />
                    </div>
                    <div class="form-col">
                        <label for="entryType">Type *</label>
                        <select id="entryType" required>
                            <option value="recette-bnc">Recette BNC (Droits d'auteur)</option>
                            <option value="recette-ts">Recette TS (Traitements et salaires)</option>
                            <option value="depense">D√©pense d√©ductible</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="entryAmount" id="amountLabel">Montant (‚Ç¨) *</label>
                        <input type="number" id="entryAmount" step="0.01" placeholder="0.00" required />
                    </div>
                    <div class="form-col hidden" id="ttcGroup">
                        <label for="entryAmountTTC">Montant TTC (‚Ç¨)</label>
                        <input type="number" id="entryAmountTTC" step="0.01" readonly />
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="entryTVA" />
                    <label for="entryTVA">TVA √† 20%</label>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <label for="entryDescription">Description</label>
                        <input type="text" id="entryDescription" placeholder="Description de l'op√©ration" />
                    </div>
                    <div class="form-col">
                        <label for="entryCategory">Cat√©gorie</label>
                        <select id="entryCategory">
                            <option value="">S√©lectionner...</option>
                            <optgroup label="Recettes BNC">
                                <option value="droits-auteur">Droits d'auteur</option>
                                <option value="commissions">Commissions</option>
                                <option value="autres-bnc">Autres revenus BNC</option>
                            </optgroup>
                            <optgroup label="Recettes TS">
                                <option value="salaires">Salaires</option>
                                <option value="cachets">Cachets</option>
                            </optgroup>
                            <optgroup label="D√©penses">
                                <option value="materiel">Mat√©riel</option>
                                <option value="transport">Transport</option>
                                <option value="formation">Formation</option>
                                <option value="cotisations">Cotisation sociale</option>
                                <option value="licences">Licences</option>
                                <option value="abonnement">Abonnement</option>
                                <option value="divers">Divers</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <div class="checkbox-group" id="recurrentField" style="display: none;">
                    <input type="checkbox" id="entryRecurrent" />
                    <label for="entryRecurrent">D√©pense mensuelle r√©currente</label>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" id="submitBtn">Ajouter</button>
                    <button class="btn btn-danger" id="cancelBtn" style="display: none;">Annuler</button>
                </div>
            </div>
            
            <h3>Derni√®res op√©rations</h3>
            <div class="entries-list" id="entriesList"></div>
        </section>
        
        <!-- Historique -->
        <section id="historique" class="tab-content" role="tabpanel">
            <h2>Historique d√©taill√©</h2>
            
            <div class="card">
                <div class="form-row">
                    <div class="form-col">
                        <label for="filterPeriod">P√©riode</label>
                        <select id="filterPeriod">
                            <option value="all">Toute la p√©riode</option>
                            <option value="current-year">Ann√©e en cours</option>
                            <option value="last-6-months">6 derniers mois</option>
                            <option value="current-month">Mois en cours</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="filterType">Type</label>
                        <select id="filterType">
                            <option value="all">Tous types</option>
                            <option value="recette-bnc">Recettes BNC</option>
                            <option value="recette-ts">Recettes TS</option>
                            <option value="depense">D√©penses</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <h3>üìä Statistiques de la p√©riode</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>Op√©rations</h4>
                        <div id="historyCount">0</div>
                    </div>
                    <div class="summary-item">
                        <h4>Total recettes</h4>
                        <div id="historyRecettes">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>Total d√©penses</h4>
                        <div id="historyDepenses">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>Solde</h4>
                        <div id="historySolde">0,00 ‚Ç¨</div>
                    </div>
                </div>
            </div>
            
            <div class="entries-list" id="historyEntriesList"></div>
        </section>
        
        <!-- Synth√®se -->
        <section id="synthese" class="tab-content" role="tabpanel">
            <h2>Synth√®se annuelle <span id="currentYear"></span></h2>
            
            <div class="summary-card">
                <h3>üìä R√©sum√© financier</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>Recettes BNC HT</h4>
                        <div id="totalBNC">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>TVA collect√©e</h4>
                        <div id="tvaCollectee">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>Recettes TS</h4>
                        <div id="totalTS">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>D√©penses HT</h4>
                        <div id="totalDepenses">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>TVA d√©ductible</h4>
                        <div id="tvaDeductible">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>B√©n√©fice net</h4>
                        <div id="beneficeNet">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>Cotisations URSSAF</h4>
                        <div id="cotisationsURSSAF">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item">
                        <h4>Cotisations IRCEC</h4>
                        <div id="cotisationsIRCEC">0,00 ‚Ç¨</div>
                    </div>
                </div>
            </div>
            
            <div class="tva-section">
                <h3>üí∂ Bilan TVA</h3>
                <div class="summary-grid">
                    <div class="summary-item" style="background: white; color: #333;">
                        <h4>TVA collect√©e</h4>
                        <div id="tvaCollecteeSynthese">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item" style="background: white; color: #333;">
                        <h4>TVA d√©ductible</h4>
                        <div id="tvaDeductibleSynthese">0,00 ‚Ç¨</div>
                    </div>
                    <div class="summary-item" style="background: white; color: #667eea;">
                        <h4>TVA √† payer</h4>
                        <div id="tvaAPayer">0,00 ‚Ç¨</div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>üìã R√©gime fiscal :</strong> <span id="regimeInfo">Micro-BNC (abattement 34%)</span><br>
                <strong>üí∞ Seuil micro-BNC :</strong> 77 700 ‚Ç¨ (2024)
            </div>
        </section>
        
        <!-- D√©claration -->
        <section id="declaration" class="tab-content" role="tabpanel">
            <h2>Montants √† reporter</h2>
            
            <div class="card">
                <h3>üìÑ D√©claration 2042-C-PRO</h3>
                <table>
                    <tr>
                        <th>Case</th>
                        <th>Description</th>
                        <th>Montant</th>
                    </tr>
                    <tr>
                        <td><strong>5QC / 5QI</strong></td>
                        <td>Revenus BNC</td>
                        <td id="case5QC">0,00 ‚Ç¨</td>
                    </tr>
                    <tr>
                        <td><strong>1GF / 1JF</strong></td>
                        <td>Traitements et salaires</td>
                        <td id="case1GF">0,00 ‚Ç¨</td>
                    </tr>
                </table>
            </div>
            
            <div class="tva-section">
                <h3>üí∂ D√©claration CA3 (TVA)</h3>
                <table>
                    <tr>
                        <th>Ligne</th>
                        <th>Description</th>
                        <th>Montant</th>
                    </tr>
                    <tr>
                        <td><strong>TVA collect√©e</strong></td>
                        <td>Sur ventes</td>
                        <td id="tvaCollecteeCA3">0,00 ‚Ç¨</td>
                    </tr>
                    <tr>
                        <td><strong>TVA d√©ductible</strong></td>
                        <td>Sur achats</td>
                        <td id="tvaDeductibleCA3">0,00 ‚Ç¨</td>
                    </tr>
                    <tr>
                        <td><strong>TVA √† payer</strong></td>
                        <td>Montant net</td>
                        <td id="tvaAPayerCA3">0,00 ‚Ç¨</td>
                    </tr>
                </table>
            </div>
        </section>
        
        <!-- Export -->
        <section id="export" class="tab-content" role="tabpanel">
            <h2>Export des donn√©es</h2>
            
            <div class="card">
                <h3>üìä Export des op√©rations</h3>
                <div class="form-row">
                    <div class="form-col">
                        <label for="exportFormat">Format</label>
                        <select id="exportFormat">
                            <option value="csv">CSV</option>
                            <option value="json">JSON</option>
                            <option value="excel">Excel (TSV)</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="exportPeriod">P√©riode</label>
                        <select id="exportPeriod">
                            <option value="all">Toutes les donn√©es</option>
                            <option value="current-year">Ann√©e en cours</option>
                            <option value="last-year">Ann√©e pr√©c√©dente</option>
                        </select>
                    </div>
                </div>
                <button class="btn" id="exportBtn">üíæ Exporter</button>
            </div>
            
            <div class="card">
                <h3>üìÑ Export synth√®se fiscale</h3>
                <button class="btn btn-info" id="exportFiscalBtn">üìÑ Exporter la synth√®se (TXT)</button>
            </div>
        </section>
        
        <!-- Param√®tres -->
        <section id="parametres" class="tab-content" role="tabpanel">
            <h2>Param√®tres</h2>
            
            <div class="card">
                <h3>‚öôÔ∏è R√©gime fiscal</h3>
                <div class="form-col">
                    <label for="regimeFiscal">Type de r√©gime BNC</label>
                    <select id="regimeFiscal">
                        <option value="micro">Micro-BNC (abattement 34%)</option>
                        <option value="reel">D√©claration contr√¥l√©e (frais r√©els)</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <h3>üíº Taux de cotisations</h3>
                <div class="form-row">
                    <div class="form-col">
                        <label for="tauxCotisations">Taux URSSAF (%)</label>
                        <input type="number" id="tauxCotisations" value="17.5" step="0.01" />
                    </div>
                    <div class="form-col">
                        <label for="tauxIRCEC">Taux IRCEC - RAAP (%)</label>
                        <input type="number" id="tauxIRCEC" value="8.00" step="0.01" />
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üóÇÔ∏è Gestion des donn√©es</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" id="exportJsonBtn">üíæ Sauvegarder JSON</button>
                    <button class="btn btn-info" id="importBtn">üìÅ Importer JSON</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" />
                    <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Effacer toutes les donn√©es</button>
                </div>
            </div>
        </section>
        
        <!-- Aide -->
        <section id="aide" class="tab-content" role="tabpanel">
            <h2>Mode d'emploi</h2>
            
            <div class="card">
                <h3>üéØ Objectif</h3>
                <p>Cette application vous aide √† g√©rer votre comptabilit√© BNC en tant qu'artiste-auteur. Elle calcule automatiquement vos d√©clarations fiscales et cotisations sociales.</p>
            </div>
            
            <div class="card">
                <h3>üìä Saisie</h3>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li><strong>Recettes BNC :</strong> Droits d'auteur, commissions, ventes d'≈ìuvres</li>
                    <li><strong>Recettes TS :</strong> Salaires assimil√©s (rare pour artistes-auteurs)</li>
                    <li><strong>D√©penses :</strong> Toutes charges professionnelles d√©ductibles</li>
                    <li><strong>TVA :</strong> Cochez si vous facturez/payez la TVA √† 20%</li>
                    <li><strong>R√©currence :</strong> Pour les abonnements mensuels</li>
                </ul>
            </div>
            
            <div class="card">
                <h3>üí∂ Gestion TVA</h3>
                <p><strong>Si vous √™tes assujetti √† la TVA :</strong></p>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li>Cochez "TVA √† 20%" pour vos recettes ‚Üí Montant TTC calcul√© automatiquement</li>
                    <li>Cochez "TVA √† 20%" pour vos d√©penses professionnelles</li>
                    <li>Le bilan TVA vous indique le montant √† payer/r√©cup√©rer</li>
                </ul>
            </div>
            
            <div class="card">
                <h3>üìã R√©gimes fiscaux</h3>
                <p><strong>Micro-BNC :</strong> Abattement forfaitaire de 34%, pas de justification des d√©penses, plafonn√© √† 77 700‚Ç¨</p>
                <p><strong>D√©claration contr√¥l√©e :</strong> D√©duction des frais r√©els, n√©cessite justificatifs, avantageux si charges > 34%</p>
            </div>
            
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Important :</strong> Cet outil est une aide √† la gestion. Pour toute d√©cision fiscale, consultez un expert-comptable ou votre centre de gestion agr√©√©.
            </div>
        </section>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Configuration
        const STORE_KEY = 'aa_accounts_v2';
        let entries = [];
        let editId = null;
        
        // Utilitaires
        const $ = id => document.getElementById(id);
        const fmt = n => Number(n).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨';
        const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        
        // Storage
        function saveStore() {
            localStorage.setItem(STORE_KEY, JSON.stringify(entries));
            renderAll();
        }
        
        function loadStore() {
            try {
                const raw = localStorage.getItem(STORE_KEY);
                entries = raw ? JSON.parse(raw) : [];
            } catch (e) {
                console.error('Erreur de chargement', e);
                entries = [];
            }
        }
        
        // Gestion des onglets
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                tabButtons.forEach(b => b.setAttribute('aria-selected', 'false'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.setAttribute('aria-selected', 'true');
                const panel = $(btn.getAttribute('aria-controls'));
                if (panel) panel.classList.add('active');
                if (btn.getAttribute('aria-controls') === 'historique') {
                    renderHistoryFiltered();
                }
                if (btn.getAttribute('aria-controls') === 'synthese' || btn.getAttribute('aria-controls') === 'declaration') {
                    computeSummaries();
                }
            });
        });
        
        // Gestion du formulaire
        $('entryType').addEventListener('change', () => {
            const type = $('entryType').value;
            $('recurrentField').style.display = type === 'depense' ? 'block' : 'none';
        });
        
        $('entryTVA').addEventListener('change', () => {
            const hasTVA = $('entryTVA').checked;
            const type = $('entryType').value;
            
            if (hasTVA) {
                $('amountLabel').textContent = 'Montant HT (‚Ç¨) *';
                $('ttcGroup').classList.remove('hidden');
            } else {
                $('amountLabel').textContent = 'Montant (‚Ç¨) *';
                $('ttcGroup').classList.add('hidden');
            }
        });
        
        $('entryAmount').addEventListener('input', () => {
            if ($('entryTVA').checked) {
                const ht = parseFloat($('entryAmount').value) || 0;
                $('entryAmountTTC').value = (ht * 1.20).toFixed(2);
            }
        });
        
        // Soumission du formulaire
        $('submitBtn').addEventListener('click', submitEntry);
        $('cancelBtn').addEventListener('click', cancelEdit);
        
        function submitEntry() {
            const date = $('entryDate').value;
            const type = $('entryType').value;
            const amount = parseFloat($('entryAmount').value);
            const description = $('entryDescription').value.trim();
            const category = $('entryCategory').value;
            const recurrent = $('entryRecurrent').checked;
            const hasTVA = $('entryTVA').checked;
            
            if (!date) {
                alert('Date requise');
                return;
            }
            if (!amount || isNaN(amount)) {
                alert('Montant invalide');
                return;
            }
            
            const tva = hasTVA ? amount * 0.20 : 0;
            const ttc = hasTVA ? amount * 1.20 : amount;
            
            const item = {
                id: editId || uid(),
                date,
                type,
                amount,
                description,
                category,
                recurrent,
                hasTVA,
                tva,
                ttc
            };
            
            if (editId) {
                const idx = entries.findIndex(e => e.id === editId);
                if (idx > -1) entries[idx] = item;
                editId = null;
                $('cancelBtn').style.display = 'none';
                $('submitBtn').textContent = 'Ajouter';
            } else {
                entries.push(item);
            }
            
            clearForm();
            saveStore();
            alert('‚úÖ Entr√©e enregistr√©e !');
        }
        
        function clearForm() {
            $('entryDate').value = '';
            $('entryAmount').value = '';
            $('entryAmountTTC').value = '';
            $('entryDescription').value = '';
            $('entryCategory').value = '';
            $('entryRecurrent').checked = false;
            $('entryTVA').checked = false;
            $('recurrentField').style.display = 'none';
            $('ttcGroup').classList.add('hidden');
            $('amountLabel').textContent = 'Montant (‚Ç¨) *';
        }
        
        function cancelEdit() {
            editId = null;
            clearForm();
            $('submitBtn').textContent = 'Ajouter';
            $('cancelBtn').style.display = 'none';
        }
        
        // Affichage des entr√©es
        function renderEntries() {
            const root = $('entriesList');
            root.innerHTML = '';
            
            if (entries.length === 0) {
                root.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Aucune entr√©e pour l\'instant</div>';
                return;
            }
            
            const sorted = [...entries].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 10);
            
            sorted.forEach(e => {
                const div = document.createElement('div');
                div.className = 'entry';
                
                const isRecette = e.type.startsWith('recette');
                const amountClass = isRecette ? 'amount-positive' : 'amount-negative';
                const displayAmount = isRecette ? e.amount : -e.amount;
                
                div.innerHTML = `
                    <div class="entry-info">
                        <div class="entry-date">${new Date(e.date).toLocaleDateString('fr-FR')}</div>
                        <div class="entry-description">${escapeHtml(e.description || 'Sans description')} ‚Ä¢ ${e.category || '‚Äî'}</div>
                        ${e.hasTVA ? '<small style="color: #0066cc;">TVA 20%</small>' : ''}
                    </div>
                    <div class="entry-actions">
                        <div class="${amountClass}">${fmt(displayAmount)}</div>
                        <button class="btn btn-warning btn-sm" onclick="startEdit('${e.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="removeEntry('${e.id}')">üóëÔ∏è</button>
                    </div>
                `;
                
                root.appendChild(div);
            });
        }
        
        function startEdit(id) {
            const e = entries.find(x => x.id === id);
            if (!e) return;
            
            editId = id;
            $('entryDate').value = e.date;
            $('entryType').value = e.type;
            $('entryAmount').value = e.amount;
            $('entryDescription').value = e.description;
            $('entryCategory').value = e.category;
            $('entryRecurrent').checked = !!e.recurrent;
            $('entryTVA').checked = !!e.hasTVA;
            
            $('recurrentField').style.display = e.type === 'depense' ? 'block' : 'none';
            
            if (e.hasTVA) {
                $('amountLabel').textContent = 'Montant HT (‚Ç¨) *';
                $('ttcGroup').classList.remove('hidden');
                $('entryAmountTTC').value = e.ttc.toFixed(2);
            }
            
            $('submitBtn').textContent = 'Enregistrer';
            $('cancelBtn').style.display = 'inline-block';
            
            document.querySelector('.tab-btn[aria-controls="saisie"]').click();
            window.scrollTo(0, 0);
        }
        
        function removeEntry(id) {
            if (!confirm('Supprimer cette entr√©e ?')) return;
            entries = entries.filter(e => e.id !== id);
            saveStore();
        }
        
        // Historique filtr√©
        const filterEls = ['filterPeriod', 'filterType'].map(id => $(id));
        filterEls.forEach(el => el.addEventListener('change', renderHistoryFiltered));
        
        function renderHistoryFiltered() {
            const period = $('filterPeriod').value;
            const type = $('filterType').value;
            
            const filtered = entries.filter(e => {
                if (type !== 'all' && e.type !== type) return false;
                
                if (period === 'all') return true;
                
                const now = new Date();
                const d = new Date(e.date);
                
                if (period === 'current-year') return d.getFullYear() === now.getFullYear();
                if (period === 'last-6-months') {
                    const past = new Date();
                    past.setMonth(now.getMonth() - 6);
                    return d >= past && d <= now;
                }
                if (period === 'current-month') {
                    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
                }
                
                return true;
            });
            
            const root = $('historyEntriesList');
            root.innerHTML = '';
            
            if (filtered.length === 0) {
                root.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Aucune entr√©e pour cette p√©riode</div>';
            }
            
            filtered.sort((a, b) => b.date.localeCompare(a.date)).forEach(e => {
                const div = document.createElement('div');
                div.className = 'entry';
                
                const isRecette = e.type.startsWith('recette');
                const amountClass = isRecette ? 'amount-positive' : 'amount-negative';
                const displayAmount = isRecette ? e.amount : -e.amount;
                
                div.innerHTML = `
                    <div class="entry-info">
                        <div class="entry-date">${new Date(e.date).toLocaleDateString('fr-FR')}</div>
                        <div class="entry-description">${escapeHtml(e.description || 'Sans description')} ‚Ä¢ ${e.category || '‚Äî'}</div>
                        ${e.hasTVA ? '<small style="color: #0066cc;">TVA 20% | HT: ' + fmt(e.amount) + ' | TTC: ' + fmt(e.ttc) + '</small>' : ''}
                    </div>
                    <div class="${amountClass}">${fmt(displayAmount)}</div>
                `;
                
                root.appendChild(div);
            });
            
            const count = filtered.length;
            const recettes = filtered.filter(x => x.type.startsWith('recette')).reduce((s, x) => s + Number(x.amount), 0);
            const depenses = filtered.filter(x => x.type === 'depense').reduce((s, x) => s + Number(x.amount), 0);
            const solde = recettes - depenses;
            
            $('historyCount').textContent = count;
            $('historyRecettes').textContent = fmt(recettes);
            $('historyDepenses').textContent = fmt(depenses);
            $('historySolde').textContent = fmt(solde);
        }
        
        // Calcul des synth√®ses
        function computeSummaries() {
            const now = new Date();
            $('currentYear').textContent = now.getFullYear();
            
            let totalBNC = 0;
            let totalTS = 0;
            let totalDepenses = 0;
            let tvaCollectee = 0;
            let tvaDeductible = 0;
            
            entries.forEach(e => {
                if (e.type === 'recette-bnc') {
                    totalBNC += e.amount;
                    if (e.hasTVA) tvaCollectee += e.tva;
                } else if (e.type === 'recette-ts') {
                    totalTS += e.amount;
                } else if (e.type === 'depense') {
                    totalDepenses += e.amount;
                    if (e.hasTVA) tvaDeductible += e.tva;
                }
            });
            
            const tvaAPayer = tvaCollectee - tvaDeductible;
            
            const tauxURSSAF = Number($('tauxCotisations').value) / 100;
            const tauxIRCEC = Number($('tauxIRCEC').value) / 100;
            const cotURSSAF = totalBNC * tauxURSSAF;
            const cotIRCEC = totalBNC * tauxIRCEC;
            const totalCot = cotURSSAF + cotIRCEC;
            
            const beneficeBrut = totalBNC - totalDepenses;
            const beneficeNet = beneficeBrut - totalCot;
            
            const regime = $('regimeFiscal').value;
            let montantDeclaration;
            
            if (regime === 'micro') {
                montantDeclaration = totalBNC;
                $('regimeInfo').textContent = 'Micro-BNC (abattement 34%)';
            } else {
                montantDeclaration = beneficeBrut;
                $('regimeInfo').textContent = 'D√©claration contr√¥l√©e (frais r√©els)';
            }
            
            $('totalBNC').textContent = fmt(totalBNC);
            $('totalTS').textContent = fmt(totalTS);
            $('totalDepenses').textContent = fmt(totalDepenses);
            $('tvaCollectee').textContent = fmt(tvaCollectee);
            $('tvaDeductible').textContent = fmt(tvaDeductible);
            $('beneficeNet').textContent = fmt(beneficeNet);
            $('cotisationsURSSAF').textContent = fmt(cotURSSAF);
            $('cotisationsIRCEC').textContent = fmt(cotIRCEC);
            
            $('tvaCollecteeSynthese').textContent = fmt(tvaCollectee);
            $('tvaDeductibleSynthese').textContent = fmt(tvaDeductible);
            $('tvaAPayer').textContent = fmt(tvaAPayer);
            
            $('case5QC').textContent = fmt(montantDeclaration);
            $('case1GF').textContent = fmt(totalTS);
            
            $('tvaCollecteeCA3').textContent = fmt(tvaCollectee);
            $('tvaDeductibleCA3').textContent = fmt(tvaDeductible);
            $('tvaAPayerCA3').textContent = fmt(tvaAPayer);
        }
        
        // Export
        $('exportBtn').addEventListener('click', () => {
            const format = $('exportFormat').value;
            const period = $('exportPeriod').value;
            
            let filtered = [...entries];
            
            if (period === 'current-year') {
                const y = new Date().getFullYear();
                filtered = filtered.filter(e => new Date(e.date).getFullYear() === y);
            } else if (period === 'last-year') {
                const y = new Date().getFullYear() - 1;
                filtered = filtered.filter(e => new Date(e.date).getFullYear() === y);
            }
            
            if (format === 'csv') {
                exportCSV(filtered);
            } else if (format === 'excel') {
                exportTSV(filtered);
            } else {
                exportJSON(filtered);
            }
        });
        
        function exportCSV(data) {
            const header = ['Date', 'Type', 'Montant HT', 'TVA', 'Montant TTC', 'Description', 'Cat√©gorie', 'R√©current'];
            const rows = data.map(r => [
                r.date,
                r.type,
                r.amount.toFixed(2),
                r.hasTVA ? r.tva.toFixed(2) : '0',
                r.ttc.toFixed(2),
                `"${(r.description || '').replace(/"/g, '""')}"`,
                r.category || '',
                r.recurrent ? 'Oui' : 'Non'
            ].join(',')).join('\n');
            
            const csv = header.join(',') + '\n' + rows;
            downloadFile(csv, `export_${new Date().toISOString().slice(0, 10)}.csv`, 'text/csv;charset=utf-8;');
        }
        
        function exportTSV(data) {
            const header = ['Date', 'Type', 'Montant HT', 'TVA', 'Montant TTC', 'Description', 'Cat√©gorie', 'R√©current'];
            const rows = data.map(r => [
                r.date,
                r.type,
                r.amount.toFixed(2),
                r.hasTVA ? r.tva.toFixed(2) : '0',
                r.ttc.toFixed(2),
                r.description || '',
                r.category || '',
                r.recurrent ? 'Oui' : 'Non'
            ].join('\t')).join('\n');
            
            const tsv = header.join('\t') + '\n' + rows;
            downloadFile(tsv, `export_${new Date().toISOString().slice(0, 10)}.tsv`, 'text/tab-separated-values;charset=utf-8;');
        }
        
        function exportJSON(data) {
            downloadFile(JSON.stringify(data, null, 2), `export_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
        }
        
        function downloadFile(content, filename, mime) {
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(url);
                a.remove();
            }, 500);
        }
        
        $('exportJsonBtn').addEventListener('click', () => {
            downloadFile(JSON.stringify(entries, null, 2), `aa_data_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
        });
        
        $('exportFiscalBtn').addEventListener('click', () => {
            let totalBNC = 0, totalTS = 0, totalDepenses = 0, tvaC = 0, tvaD = 0;
            
            entries.forEach(e => {
                if (e.type === 'recette-bnc') {
                    totalBNC += e.amount;
                    if (e.hasTVA) tvaC += e.tva;
                } else if (e.type === 'recette-ts') {
                    totalTS += e.amount;
                } else if (e.type === 'depense') {
                    totalDepenses += e.amount;
                    if (e.hasTVA) tvaD += e.tva;
                }
            });
            
            const tvaAPayer = tvaC - tvaD;
            const regime = $('regimeFiscal').value === 'micro' ? 'Micro-BNC (abattement 34%)' : 'D√©claration contr√¥l√©e';
            
            const text = `=== SYNTH√àSE FISCALE ARTISTE-AUTEUR ===
Date: ${new Date().toLocaleDateString('fr-FR')}

RECETTES:
- Droits d'auteur BNC HT: ${fmt(totalBNC)}
- TVA collect√©e: ${fmt(tvaC)}
- Traitements et Salaires: ${fmt(totalTS)}

CHARGES:
- Total d√©penses HT: ${fmt(totalDepenses)}
- TVA d√©ductible: ${fmt(tvaD)}

TVA:
- TVA √† payer: ${fmt(tvaAPayer)}

R√âGIME FISCAL: ${regime}

D√âCLARATION 2042-C-PRO:
- Case 5QC/5QI (BNC): ${$('case5QC').textContent}
- Case 1GF/1JF (TS): ${$('case1GF').textContent}

COTISATIONS SOCIALES:
- URSSAF: ${$('cotisationsURSSAF').textContent}
- IRCEC: ${$('cotisationsIRCEC').textContent}
`;
            
            downloadFile(text, `synthese_fiscale_${new Date().toISOString().slice(0, 10)}.txt`, 'text/plain;charset=utf-8;');
        });
        
        // Import
        $('importBtn').addEventListener('click', () => $('importFile').click());
        
        $('importFile').addEventListener('change', (ev) => {
            const f = ev.target.files[0];
            if (!f) return;
            
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (Array.isArray(parsed)) {
                        const valid = parsed.every(it => it.date && it.amount !== undefined && it.type);
                        if (!valid) throw new Error('Format invalide');
                        entries = parsed;
                        saveStore();
                        alert('‚úÖ Import r√©ussi !');
                    } else {
                        alert('Le fichier JSON doit contenir un tableau');
                    }
                } catch (err) {
                    alert('‚ùå Erreur d\'import: ' + err.message);
                }
            };
            r.readAsText(f);
        });
        
        // Clear
        $('clearBtn').addEventListener('click', () => {
            if (confirm('‚ö†Ô∏è Supprimer toutes les donn√©es ? Cette action est irr√©versible.')) {
                entries = [];
                saveStore();
                alert('‚úÖ Donn√©es effac√©es');
            }
        });
        
        // Changements de param√®tres
        $('tauxCotisations').addEventListener('change', computeSummaries);
        $('tauxIRCEC').addEventListener('change', computeSummaries);
        $('regimeFiscal').addEventListener('change', computeSummaries);
        
        // Render all
        function renderAll() {
            renderEntries();
            renderHistoryFiltered();
            computeSummaries();
        }
        
        function escapeHtml(s) {
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        
        // Initialisation
        loadStore();
        renderAll();
        
        // Date par d√©faut
        $('entryDate').value = new Date().toISOString().split('T')[0];
        
        console.log('‚úÖ Application charg√©e - ' + entries.length + ' entr√©es');
    </script>
</body>
</html>
